<!-- stringart_app/templates/core/home.html -->
{% load static %}
<!DOCTYPE html>
<html lang="en-gb">
<head>
  <meta charset="utf-8">
  <title>String Art Prototype - Test Suite</title>

  <!-- Load Montserrat font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap"
    rel="stylesheet"
  >

  <!-- Extracted CSS -->
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
  <h1>String Art Prototype - Test Suite</h1>

  <section class="controls">
    <form method="post">
      {% csrf_token %}
      <label for="algorithm">Algorithm:</label>
      <select name="algorithm" id="algorithm">
        {% for key in algorithms %}
          <option value="{{ key }}" {% if key == selected_algorithm %}selected{% endif %}>
            {{ key|capfirst }}
          </option>
        {% endfor %}
      </select>
      <button type="submit">Run</button>
    </form>

    <!-- Debug terminal: live-updating via SSE -->
    <div id="debug-terminal">
      <pre id="log-content"></pre>
    </div>
  </section>

  <section>
    <h2>Raw Test Images</h2>
    <div class="preview-grid">
      {% for name in test_images %}
        <div>
          <h3>{{ name }}</h3>
          <img
            src="{% static 'test_images/'|add:name %}"
            alt="{{ name }}"
          >
        </div>
      {% endfor %}
    </div>
  </section>

  {% if test_results %}
    <section>
      <h2>Results (Grayscale + Physics)</h2>
      <div class="preview-grid">
        {% for t in test_results %}
          <div>
            <h3>{{ t.name }}</h3>
            <img
              src="data:image/png;base64,{{ t.processed_image }}"
              alt="{{ t.name }} (grayscale)"
            >

            <!-- Collapsible vector list showing count -->
            <details>
              <summary>Show vector list ({{ t.vectors_count }} vectors)</summary>
              <pre class="vectors">{{ t.vectors_json }}</pre>
            </details>

            <canvas
              class="physicsCanvas"
              width="200"
              height="200"
              data-anchors='{{ t.anchors_json|escape }}'
              data-vectors='{{ t.vectors_json|escape }}'
            ></canvas>
          </div>
        {% endfor %}
      </div>
    </section>
  {% endif %}

  <script type="module" src="{% static 'js/main.js' %}"></script>
  <script>
    // Open SSE connection to stream new log lines as they occur
    const evtSource = new EventSource("{% url 'stream_logs' %}");
    const logPre = document.getElementById("log-content");
    evtSource.onmessage = e => {
      logPre.textContent += e.data + "\n";
      const container = document.getElementById("debug-terminal");
      container.scrollTop = container.scrollHeight;
    };
  </script>
</body>
</html>

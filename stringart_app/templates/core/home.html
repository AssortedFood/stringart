<!-- stringart_app/templates/core/home.html -->
{% load static %}
<!DOCTYPE html>
<html lang="en-gb">
<head>
  <meta charset="utf-8">
  <title>String Art Prototype</title>

  <!-- Load Montserrat font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap"
    rel="stylesheet"
  >

  <!-- Extracted CSS -->
  <link rel="stylesheet" href="{% static 'css/style.css' %}">

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">
</head>
<body>
  <h1>String Art Prototype</h1>

  <section class="controls">
    <form method="post">
      {% csrf_token %}
      <label for="algorithm">Algorithm:</label>
      <select name="algorithm" id="algorithm">
        {% for key in algorithms %}
          <option value="{{ key }}" {% if key == selected_algorithm %}selected{% endif %}>
            {{ key|capfirst }}
          </option>
        {% endfor %}
      </select>
      <button type="submit">Run</button>
    </form>

    <!-- Debug terminal: live-updating via SSE -->
    <div id="debug-terminal">
      <pre id="log-content"></pre>
    </div>
  </section>

  <section>
    <h2>Raw Test Images</h2>
    <div class="preview-grid">
      {% for name in test_images %}
        <div>
          <h3>{{ name }}</h3>
          <img
            src="{% static 'test_images/'|add:name %}"
            alt="{{ name }}"
          >
        </div>
      {% endfor %}
    </div>
  </section>

  <section>
    <h2>Results (Grayscale + Physics)</h2>
    <div class="preview-grid" id="results-container">
      <!-- Processed images & canvases will stream in here -->
    </div>
  </section>

  <!-- Core physics init (unused for now) -->
  <script type="module" src="{% static 'js/main.js' %}"></script>

  <!-- SSE for logs -->
  <script>
    const evtSource = new EventSource("{% url 'stream_logs' %}");
    const logPre = document.getElementById("log-content");
    evtSource.onmessage = e => {
      logPre.textContent += e.data + "\n";
      document.getElementById("debug-terminal").scrollTop =
        document.getElementById("debug-terminal").scrollHeight;
    };
  </script>

  <!-- SSE + dynamic appending for results -->
  <script type="module">
    import { createPhysicsRenderer } from "{% static 'js/physics_renderer.js' %}";

    const resultsContainer = document.getElementById("results-container");
    const resSource = new EventSource("{% url 'stream_results' %}");

    resSource.onmessage = e => {
      const t = JSON.parse(e.data);

      // 1) Create wrapper & title
      const wrapper = document.createElement("div");
      const title = document.createElement("h3");
      title.textContent = t.name;
      wrapper.appendChild(title);

      // 2) Create and append the grayscale <img> immediately
      const img = document.createElement("img");
      img.src = `data:image/png;base64,${t.processed_image}`;
      img.alt = `${t.name} (grayscale)`;
      wrapper.appendChild(img);

      // 3) Create & append the <details> block
      const details = document.createElement("details");
      const summary = document.createElement("summary");
      summary.textContent = `Show vector list (${t.vectors_count} vectors)`;
      const pre = document.createElement("pre");
      pre.className = "vectors";
      pre.textContent = t.vectors_json;
      details.appendChild(summary);
      details.appendChild(pre);
      wrapper.appendChild(details);

      // 4) Append wrapper to container so user sees it right away
      resultsContainer.appendChild(wrapper);

      // 5) In the next tick, create & initialize the physics canvas
      setTimeout(() => {
        const canvas = document.createElement("canvas");
        canvas.className = "physicsCanvas";
        canvas.width = 200;
        canvas.height = 200;
        canvas.dataset.anchors = t.anchors_json;
        canvas.dataset.vectors = t.vectors_json;
        wrapper.appendChild(canvas);

        try {
          const anchors = JSON.parse(canvas.dataset.anchors);
          const vectors = JSON.parse(canvas.dataset.vectors);
          createPhysicsRenderer(canvas, anchors, vectors);
        } catch (err) {
          console.error("Failed to init physicsCanvas for", t.name, err);
        }
      }, 0);
    };
  </script>
</body>
</html>

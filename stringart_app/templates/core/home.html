<!-- stringart_app/templates/core/home.html -->
{% load static %}
<!DOCTYPE html>
<html lang="en-gb">
<head>
  <meta charset="utf-8">
  <title>String Art Prototype</title>

  <!-- Load Montserrat font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap"
    rel="stylesheet"
  >

  <!-- Extracted CSS -->
  <link rel="stylesheet" href="{% static 'css/style.css' %}">

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">
</head>
<body>
  <h1>String Art Prototype</h1>

  <section class="controls">
    <form id="algo-form" method="post" action=".">
      {% csrf_token %}
      <fieldset>
        <legend>Run algorithms:</legend>
        {% for key in algorithms %}
          <label>
            <input
              type="checkbox"
              name="algorithms"
              value="{{ key }}"
              {% if key in selected_algorithms %}checked{% endif %}
            >
            {{ key|capfirst }}
          </label>
        {% endfor %}
      </fieldset>
      <button type="submit">Run</button>
    </form>
  </section>

  <!-- Debug terminal: hidden until Run -->
  <section id="debug-section" style="display:none;">
    <h2>Logs</h2>
    <div id="debug-terminal">
      <pre id="log-content"></pre>
    </div>
  </section>

  <section>
    <h2>Raw Test Images</h2>
    <div class="preview-grid">
      {% for name in test_images %}
        <div>
          <h3>{{ name }}</h3>
          <img
            src="{% static 'test_images/'|add:name %}"
            alt="{{ name }}"
          >
        </div>
      {% endfor %}
    </div>
  </section>

  <section id="results-section" style="display:none;">
    <h2>Results</h2>
    <div id="results-container">
      <!-- Each phase will create its own heading + .preview-grid -->
    </div>
  </section>

  <!-- Core physics init (unused for now) -->
  <script type="module" src="{% static 'js/main.js' %}"></script>

  <script type="module">
    import { createPhysicsRenderer } from "{% static 'js/physics_renderer.js' %}";

    let evtSourceLogs, evtSourceResults;
    let currentPhase = null;
    let currentRow = null;

    function capFirst(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function startStreams() {
      if (evtSourceLogs) evtSourceLogs.close();
      if (evtSourceResults) evtSourceResults.close();

      document.getElementById('log-content').textContent = '';
      const container = document.getElementById('results-container');
      container.innerHTML = '';
      currentPhase = null;
      currentRow = null;

      document.getElementById('debug-section').style.display = '';
      document.getElementById('results-section').style.display = '';

      evtSourceLogs = new EventSource("{% url 'stream_logs' %}");
      evtSourceLogs.onmessage = e => {
        document.getElementById("log-content").textContent += e.data + "\n";
        const dbg = document.getElementById("debug-terminal");
        dbg.scrollTop = dbg.scrollHeight;
      };

      evtSourceResults = new EventSource("{% url 'stream_results' %}");
      evtSourceResults.onmessage = e => {
        const t = JSON.parse(e.data);

        // new phase? heading + grid
        if (t.phase !== currentPhase) {
          currentPhase = t.phase;
          const heading = document.createElement("h3");
          heading.textContent = capFirst(currentPhase);
          container.appendChild(heading);

          currentRow = document.createElement("div");
          currentRow.className = "preview-grid";
          container.appendChild(currentRow);
        }

        // append items
        if (t.phase === 'grayscale') {
          const img = document.createElement("img");
          img.src = `data:image/png;base64,${t.processed_image}`;
          img.alt = t.name;
          currentRow.appendChild(img);

        } else if (t.phase === 'algorithm') {
          const cell = document.createElement("div");

          const details = document.createElement("details");
          const summary = document.createElement("summary");
          summary.textContent = `Show vectors (${t.vectors_count})`;
          const pre = document.createElement("pre");
          pre.className = "vectors";
          // pretty-print each vector on its own line
          const arr = JSON.parse(t.vectors_json);
          pre.textContent = JSON.stringify(arr, null, 2);
          details.appendChild(summary);
          details.appendChild(pre);
          cell.appendChild(details);

          const canvas = document.createElement("canvas");
          canvas.className = "physicsCanvas";
          canvas.width = 200;
          canvas.height = 200;
          canvas.dataset.anchors = t.anchors_json;
          canvas.dataset.vectors = t.vectors_json;
          cell.appendChild(canvas);

          setTimeout(() => {
            const anchors = JSON.parse(canvas.dataset.anchors);
            const vectors = JSON.parse(canvas.dataset.vectors);
            createPhysicsRenderer(canvas, anchors, vectors);
          }, 0);

          currentRow.appendChild(cell);
        }
      };
    }

    window.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('algo-form');
      form.addEventListener('submit', e => {
        e.preventDefault();
        fetch(form.action, {
          method: 'POST',
          body: new FormData(form),
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
        });
        startStreams();
      });
    });
  </script>
</body>
</html>
